---
sidebar_position: 5
---

# OIDC (OpenID Connect)

## Single Sign-On with OIDC

PLANKA can be configured to use an **OIDC (OpenID Connect)** provider for authentication. When a user logs in via OIDC:

- If the user doesn't exist in PLANKA, an account will be automatically created.
- If the user already exists and their email claim matches the email stored in PLANKA, the accounts will be linked.

### Required Configuration Values

- **OIDC_ISSUER**: The URL pointing to your identity provider. This URL is used to retrieve the `.well-known/openid-configuration` endpoint which helps to identify the necessary endpoints.
- **OIDC_CLIENT_ID**: The OAuth client ID created within the identity provider.
- **OIDC_CLIENT_SECRET**: The OAuth client secret created within the identity provider.

### Optional Configuration Values

- **OIDC_USE_OAUTH_CALLBACK**: If set to `true`, PLANKA will use an explicit OAuth callback flow. Useful with some providers that require strict callback handling.
- **OIDC_ID_TOKEN_SIGNED_RESPONSE_ALG**: The expected signing algorithm for the `id_token` (e.g., `RS256`). If set, PLANKA will validate that the token was signed with this algorithm.
- **OIDC_USERINFO_SIGNED_RESPONSE_ALG**: The expected signing algorithm for the `userinfo` response. Only required if your provider signs the `userinfo` response.
- **OIDC_SCOPES**: Scopes to request from the identity provider. This controls what data the OAuth client can access. PLANKA requires access to the `email` and `name` claims. By default, it requests `openid profile email`.
- **OIDC_RESPONSE_MODE**: Controls how the OIDC provider returns tokens to PLANKA. Common values are `fragment` or `query`. By default, it is set to `fragment`.
- **OIDC_USE_DEFAULT_RESPONSE_MODE**: If set to true, PLANKA will ignore `OIDC_RESPONSE_MODE` and use the provider's default behavior instead.
- **OIDC_ADMIN_ROLES**: The role claim used to determine if a user is an Admin.
- **OIDC_PROJECT_OWNER_ROLES**: The role claim used to determine if a user is a Project Owner.
- **OIDC_BOARD_USER_ROLES**: The role claim used to determine if a user is a Board User. Board user will also be assigned if the role claim does not match.
- **OIDC_CLAIMS_SOURCE**: Determines whether the claims are sourced from the `id_token` or `userinfo`. By default, it is set to `userinfo`.
- **OIDC_EMAIL_ATTRIBUTE**: The claim that contains the email. By default, it is `email`.
- **OIDC_NAME_ATTRIBUTE**: The claim that contains the user's name. By default, it is `name`.
- **OIDC_USERNAME_ATTRIBUTE**: The claim that contains the username. By default, it is `preferred_username`.
- **OIDC_ROLES_ATTRIBUTE**: The claim that contains role values used for PLANKA role mapping. By default, it is `groups`.
- **OIDC_IGNORE_USERNAME**: If set to `true`, the `OIDC_USERNAME_ATTRIBUTE` will be ignored. This is useful if the format of usernames in your identity provider differs from PLANKA. By default, it is not ignored.
- **OIDC_IGNORE_ROLES**: If set to `true`, all `OIDC_*_ROLES` variables and `OIDC_ROLES_ATTRIBUTE` will be ignored. This is useful if you wish to use OIDC only for authentication and not authorization, in which case user roles will be managed by PLANKA. By default, it is not ignored.
- **OIDC_ENFORCED**: If set to `true`, all built-in authentication/authorization will be disabled. By default, it is not enforced.
- **OIDC_DEBUG**: If set to `true`, the regular Login button on the login page will be replaced with a Debug button. Instead of signing the user in, detailed OIDC logs and payloads will be displayed below the button in the UI, which is useful for troubleshooting provider configuration issues.

## Examples

### Authentik

Below is an example configuration for using [Authentik](https://goauthentik.io/) as an OIDC provider. This configuration will work with any OIDC provider.

```bash
OIDC_ISSUER=https://auth.local/application/o/planka/
OIDC_CLIENT_ID=sxxaAIAxVXlCxTmc1YLHBbQr8NL8MqLI2DUbt42d
OIDC_CLIENT_SECRET=om4RTMRVHRszU7bqxB7RZNkHIzA8e4sGYWxeCwIMYQXPwEBWe4SY5a0wwCe9ltB3zrq5f0dnFnp34cEHD7QSMHsKvV9AiV5Z7eqDraMnv0I8IFivmuV5wovAECAYreSI
OIDC_SCOPES=openid profile email
OIDC_ADMIN_ROLES=planka-admin
```

> **Note:** Be sure to modify the following values:

- `auth.local` is the domain on which Authentik is hosted.
- The client ID (`sxxaAIAxVXlCxTmc1YLHBbQr8NL8MqLI2DUbt42d`) and client secret (`om4RTMRVHRszU7bqxB7RZNkHIzA8e4sGYWxeCwIMYQXPwEBWe4SY5a0wwCe9ltB3zrq5f0dnFnp34cEHD7QSMHsKvV9AiV5Z7eqDraMnv0I8IFivmuV5wovAECAYreSI`) are generated by Authentik.
- `planka-admin` is the role used in Authentik to create admin accounts (you can alternatively set `OIDC_IGNORE_ROLES` to `true`).

### Keycloak

Adjust Authentik example to work with [Keycloak](https://www.keycloak.org/docs/latest/server_admin/index.html#proc-creating-oidc-client_server_administration_guide).

```bash
OIDC_ISSUER=https://auth.local/realms/{realm-name}
OIDC_CLIENT_ID=planka
OIDC_CLIENT_SECRET={secretAutoGeneratedByKeycloak}
OIDC_ADMIN_ROLES=planka-admin
OIDC_PROJECT_OWNER_ROLES=planka-project-owner
```

If you want to use the `groups` claim (which is the default), configure your Keycloak realm as follows:
1. Go to **Clients**.
2. Click the Client ID you assigned to PLANKA (in this example, `planka`).
3. Open the **Client Scopes** tab.
4. Click `planka-dedicated`.
5. Click **Add mapper** > By configuration > Group Membership.
6. Use the following options:

```
Name: groups
Token Claim Name: groups
Full group path -> Off
Add to ID token -> On
Add to access token -> On
Add to lightweight access token -> Off
Add to userinfo -> On
Add to token introspection -> On
```

Users in the `planka-admin` or `planka-project-owner` groups will receive the corresponding roles in PLANKA.
Users without a matching group claim will be assigned the Board User role by default.

### Google

For Google OAuth setup, follow these steps:
1. Go to [Google API Credentials](https://console.cloud.google.com/apis/credentials).
2. Select an existing project or create a new one.
3. Choose **Create Credentials** > **OAuth Client ID**.
4. Set application type as **Web application**.
5. Add the following **Redirect URI**: `https://your-domain.com/oidc-callback`.
6. Set the **Client ID** and **Client Secret** as environment variables.

```bash
OIDC_ISSUER=https://accounts.google.com
OIDC_CLIENT_ID=xxx-xxx.apps.googleusercontent.com
OIDC_CLIENT_SECRET=xxxx-xxxx-xx
OIDC_SCOPES=openid profile email
```

### Synology SSO

Follow the [Synology SSO Server Tutorial](https://kb.synology.com/de-de/DSM/tutorial/set_up_oidc_for_dsm_in_sso_server) to create an OIDC application.

- Use `https://my-planka.url/oidc-callback` as the Redirect URI.
- Set the following environment variables:

```bash
OIDC_ISSUER=https://sso.mysynology.me/webman/sso
OIDC_CLIENT_ID=xxx
OIDC_CLIENT_SECRET=xxx
OIDC_NAME_ATTRIBUTE=email # Synology does not support the profile scope
OIDC_SCOPES=openid email
OIDC_IGNORE_USERNAME=true
OIDC_IGNORE_ROLES=true
```

### Microsoft Entra ID

To configure a new App Registration for PLANKA in [Entra ID](https://entra.microsoft.com/) follow these steps:

1. [Register a new application](https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-register-app).  
    - Select `Web` as the *Redirect URI* type and enter `https://your-domain.com/oidc-callback` as the URI
    - Note the *Application (client) ID* and your *Directory (tenant) ID*. 
2. [Create a secret](https://learn.microsoft.com/en-us/entra/identity-platform/how-to-add-credentials?tabs=client-secret) for the new PLANKA app.
    - Note the *Secret Value* as it will not be retrievable later. 
3. [Add the following API permissions](https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-configure-app-access-web-apis#add-permissions-to-access-your-web-api) to the PLANKA app
    - *Microsoft Graph* > *Delegated Permissions*: `email`, `openid`, `profile`
4. Add the below environment variables to your PLANKA configuration:

```bash
OIDC_CLIENT_ID=[ClientID] # Replace with Application (client) ID
OIDC_CLIENT_SECRET=[SecretValue] # Replace with Secret Value
OIDC_ISSUER=https://login.microsoftonline.com/[DirectoryID]/v2.0 # Replace with your Directory ID
OIDC_SCOPES=openid profile email
OIDC_IGNORE_ROLES=true # Do not enter this if managing roles as below
```

#### Optional: Assign PLANKA roles through Entra ID group membership

In order to use Entra ID for authorization, follow these steps: 

1. [Create security groups](https://learn.microsoft.com/en-us/entra/fundamentals/how-to-manage-groups) for the PLANKA roles (example names below) and add members.
    - `APP-Planka-Admin`
    - `APP-Planka-ProjectOwner`
    - `APP-Planka-BoardUser` (optional)
    - Note the *Object ID*s for each group
2. [Add a group claim](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-fed-group-claims#add-group-claims-to-tokens-for-saml-applications-using-sso-configuration) for the PLANKA app, ensure you select `Group ID` as the source attribute
3. Add the below environment variables to your PLANKA configuration:

```bash
OIDC_CLAIMS_SOURCE=id_token # By default userinfo claim does not include groups info
OIDC_USERNAME_ATTRIBUTE=oid # By default preferred_username will return email when id_token used and PLANKA username regex check does not allow "@"
OIDC_IGNORE_ROLES=false
OIDC_ROLES_ATTRIBUTE=groups
OIDC_ADMIN_ROLES=[ObjectID] # Replace with Object ID for PLANKA Admin security group
OIDC_PROJECT_OWNER_ROLES=[ObjectID] # Replace with Object ID for PLANKA Project Owner security group
OIDC_BOARD_USER_ROLES=[ObjectID] # Replace with Object ID for PLANKA Board User security group
OIDC_ENFORCED=true # Optional if you would like to disable local authentication
```

---

This setup will enable you to authenticate users via OIDC, linking or creating accounts automatically depending on the email claim, and giving you flexibility in managing user roles.
